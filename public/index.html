<!DOCTYPE html>
<html>
<head>
    <title>Friendopoly</title>
    <style>
        body { margin: 0; font-family: Arial; background: #222; color: #fff; overflow: hidden; }
        #game { position: relative; width: 100vw; height: 100vh; }
        canvas { display: block; }
        #ui { position: absolute; top: 10px; left: 10px; background: rgba(0,0,0,0.8); padding: 20px; border-radius: 10px; }
        button { padding: 12px 24px; margin: 5px; font-size: 16px; border: none; border-radius: 5px; cursor: pointer; background: #4CAF50; color: white; }
        button:disabled { background: #666; }
        #players { position: absolute; bottom: 10px; right: 10px; background: rgba(0,0,0,0.8); padding: 20px; border-radius: 10px; max-width: 300px; }
        .player { margin: 10px 0; padding: 10px; background: rgba(255,255,255,0.1); border-radius: 5px; }
        #chat { position: absolute; bottom: 10px; left: 10px; width: 300px; height: 200px; background: rgba(0,0,0,0.8); padding: 10px; border-radius: 10px; }
        #chatMsgs { height: 150px; overflow-y: scroll; margin-bottom: 10px; }
        #roomJoin { position: absolute; top: 50%; left: 50%; transform: translate(-50%,-50%); background: #333; padding: 40px; border-radius: 20px; text-align: center; }
        input { padding: 10px; margin: 10px; font-size: 16px; }
    </style>
</head>
<body>
    <div id="game">
        <div id="roomJoin">
            <h2>Join Game</h2>
            <input id="roomInput" placeholder="Room Code (e.g. ABCD)" value="ABCD">
            <input id="nameInput" placeholder="Your Name">
            <button onclick="joinRoom()">Join</button>
        </div>
        <canvas id="canvas"></canvas>
        <div id="ui" style="display:none;">
            <h3 id="roomCode"></h3>
            <p id="turnInfo"></p>
            <p id="posInfo"></p>
            <button id="rollBtn" onclick="roll()">Roll Dice</button>
            <button id="buyBtn" onclick="buy()" style="display:none;">Buy Property ($<span id="price"></span>)</button>
            <button id="endBtn" onclick="endTurn()">End Turn</button>
        </div>
        <div id="players" style="display:none;"></div>
        <div id="chat" style="display:none;">
            <div id="chatMsgs"></div>
            <input id="chatInput" placeholder="Chat..." onkeypress="if(event.key==='Enter') sendChat()">
            <button onclick="sendChat()">Send</button>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;

        let gameState = null;
        let room = '';
        let playerId = '';

        function joinRoom() {
            room = document.getElementById('roomInput').value.toUpperCase();
            const name = document.getElementById('nameInput').value || 'Player';
            socket.emit('joinRoom', {room, name});
            document.getElementById('roomJoin').style.display = 'none';
        }

        socket.on('roomJoined', () => {
            document.getElementById('roomCode').textContent = `Room: ${room}`;
            document.getElementById('ui').style.display = 'block';
            document.getElementById('players').style.display = 'block';
            document.getElementById('chat').style.display = 'block';
        });

        socket.on('gameState', (state) => {
            gameState = state;
            draw();
            updateUI();
        });

        socket.on('chatMsg', (msg) => {
            const div = document.getElementById('chatMsgs');
            div.innerHTML += `<p><strong>${msg.name}:</strong> ${msg.msg}</p>`;
            div.scrollTop = div.scrollHeight;
        });

        function roll() {
            socket.emit('rollDice', {room});
        }

        function buy() {
            const pos = gameState.players[socket.id]?.pos || 0;
            socket.emit('buyProperty', {room, pos});
        }

        function endTurn() {
            socket.emit('endTurn', {room});
        }

        function sendChat() {
            const msg = document.getElementById('chatInput').value;
            if(msg) {
                socket.emit('chat', {room, msg});
                document.getElementById('chatInput').value = '';
            }
        }

        function updateUI() {
            if(!gameState || !gameState.players[socket.id]) return;
            const myPlayer = gameState.players[socket.id];
            const turnPlayerId = Object.keys(gameState.players)[gameState.currentTurn];
            const turnPlayer = gameState.players[turnPlayerId];
            const prop = gameState.board[myPlayer.pos];
            document.getElementById('turnInfo').textContent = `Turn: ${turnPlayer.name} (${gameState.phase})`;
            document.getElementById('posInfo').textContent = `You: Pos ${myPlayer.pos} ${prop.name}, Cash: $${myPlayer.cash}`;
            document.getElementById('rollBtn').disabled = socket.id !== turnPlayerId || gameState.phase !== 'rolling';
            document.getElementById('buyBtn').style.display = (gameState.phase === 'action' && prop.price && !prop.owner && socket.id === turnPlayerId) ? 'inline-block' : 'none';
            document.getElementById('price').textContent = prop.price;
            document.getElementById('endBtn').disabled = socket.id !== turnPlayerId || gameState.phase !== 'action';

            // Players list
            let html = '';
            Object.values(gameState.players).forEach(p => {
                html += `<div class="player" style="border-left: 5px solid ${p.color}">
                    <strong style="color:${p.color}">${p.name}</strong>: $${p.cash} Pos:${p.pos}
                </div>`;
            });
            document.getElementById('players').innerHTML = html;
        }

        function draw() {
            ctx.fillStyle = '#1a1a2e';
            ctx.fillRect(0,0,canvas.width,canvas.height);
            if(!gameState) return;

            const size = Math.min(canvas.width, canvas.height) * 0.8;
            const cx = canvas.width / 2;
            const cy = canvas.height / 2;
            const offset = size * 0.1;
            const cell = (size * 0.8) / 11;

            // Board square
            ctx.strokeStyle = '#fff';
            ctx.lineWidth = 4;
            ctx.strokeRect(cx - size/2, cy - size/2, size, size);

            // Draw spaces
            for(let i = 0; i < 40; i++) {
                const prop = gameState.board[i];
                const [x, y, w, h] = getSpaceRect(i, cx, cy, size, offset, cell);
                ctx.fillStyle = prop.color || '#555';
                ctx.fillRect(x, y, w, h);
                ctx.strokeStyle = '#fff';
                ctx.strokeRect(x, y, w, h);
                ctx.fillStyle = 'white';
                ctx.font = 'bold 12px Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(prop.name, x + w/2, y + h/2);
                if(prop.owner) {
                    const ownerColor = gameState.players[prop.owner]?.color || '#fff';
                    ctx.fillStyle = ownerColor;
                    ctx.beginPath();
                    ctx.arc(x + w - 10, y + 10, 6, 0, Math.PI*2);
                    ctx.fill();
                }
            }

            // Players
            Object.values(gameState.players).forEach(p => {
                const [px, py] = getSpaceCenter(p.pos, cx, cy, size, offset, cell);
                ctx.fillStyle = p.color;
                ctx.beginPath();
                ctx.arc(px, py, 12, 0, Math.PI*2);
                ctx.fill();
                ctx.fillStyle = 'white';
                ctx.font = 'bold 10px Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(p.name[0], px, py);
            });
        }

        function getSpaceRect(i, cx, cy, size, offset, cell) {
            const side = Math.floor(i / 10);
            const pos = i % 10;
            if(side === 0) return [cx - size/2 + offset + pos * cell, cy + size/2 - offset - cell, cell, cell]; // bottom
            if(side === 1) return [cx + size/2 - offset - cell, cy + size/2 - offset - pos * cell - cell, cell, cell]; // right
            if(side === 2) return [cx + size/2 - offset - pos * cell - cell, cy - size/2 + offset, cell, cell]; // top
            return [cx - size/2 + offset, cy - size/2 + offset + pos * cell, cell, cell]; // left
        }

        function getSpaceCenter(i, cx, cy, size, offset, cell) {
            const rect = getSpaceRect(i, cx, cy, size, offset, cell);
            return [rect[0] + rect[2]/2, rect[1] + rect[3]/2];
        }

        window.addEventListener('resize', () => {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            draw();
        });
    </script>
</body>
</html>
